# Start from a lightweight base image
FROM python:3.12-slim AS base

# Prevent Python from writing pyc files and buffering logs
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Create a non-root user for security
RUN addgroup --system app && adduser --system --ingroup app appuser

# Set working directory
WORKDIR /app

# Copy dependency list first (for Docker layer caching)
COPY requirements.txt .

# Install dependencies efficiently (no cache, minimal image)
RUN pip install --no-cache-dir -r requirements.txt

# Copy app source code
COPY app.py .

# Change ownership and drop privileges
RUN chown -R appuser:app /app
USER appuser

# Expose port
EXPOSE 8080

# Run the app
CMD ["python", "app.py"]
